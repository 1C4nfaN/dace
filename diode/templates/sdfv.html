<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SDFG Viewer</title>
    <link rel="stylesheet" type="text/css" href="{{dir|safe}}./webclient/external_lib/material/material-icons.css">
    <link rel="stylesheet" type="text/css" href="{{dir|safe}}./webclient/sdfv.css">
    <script src="{{dir|safe}}./webclient/renderer_dir/dagre.js"></script>
    <script src="{{dir|safe}}./webclient/external_lib/jquery.min.js"></script>

    <script src="{{dir|safe}}./webclient/renderer_dir/global_vars.js"></script>
    <script src="{{dir|safe}}./webclient/renderer_elements.js"></script>
    <script src="{{dir|safe}}./webclient/context_menu.js"></script>
    <script src="{{dir|safe}}./webclient/sdfg_utils.js"></script>
    <script src="{{dir|safe}}./webclient/renderer.js"></script>
</head>
<body>
<div class="w3-sidebar w3-bar-block w3-card w3-animate-right" style="display:none;right:0;" id="sidebar">
    <button onclick="close_menu()" class="w3-bar-item w3-button w3-large">Close &times;</button>
    <h3 id="sidebar-header">Nothing selected</h3>
    <br />
    <div id="sidebar-contents"></div>
</div>
<div id="filepicker"><form><input type="file" accept=".sdfg,.json"> <input type="button" id="reload" value="Refresh"></form></div>
<div id="contents"></div>
<script>
var fr;
var file = null;
var renderer = null;
$(document).ready(function(){
    var sdfg_json = {{sdfg|safe}};
    var sdfg = parse_sdfg(sdfg_json);
    renderer = new SDFGRenderer(sdfg, document.getElementById('contents'), mouse_event);

    $('input[type="file"]').change(function(e){
        if (e.target.files.length < 1)
            return;
        file = e.target.files[0];
        reload_file();
    });
    $('#reload').click(function(e){
        reload_file();
    });
});

function reload_file() {
    if (!file)
        return;
    fr = new FileReader();
    fr.onload = file_read_complete;
    fr.readAsText(file);
}

function file_read_complete() {
    let sdfg = parse_sdfg(fr.result);
    if (renderer)
        renderer.destroy();
    renderer = new SDFGRenderer(sdfg, document.getElementById('contents'), mouse_event);
}

function mouse_event(evtype, event, mousepos, elements, renderer, elem) {
    if (evtype === 'click') {
        if (elem) {
            // Change header
            document.getElementById("sidebar-header").innerText = elem.type() + " " + elem.label();

            // Change contents
            let contents = document.getElementById("sidebar-contents");
            let html = "";
            for (let attr of Object.entries(elem.attributes())) {
                html += "<p><b>" + attr[0] + "</b>:&nbsp;&nbsp;";
                // TODO: Refactor support for property display
                if (attr[0].indexOf("code") >= 0)
                    html += '</p><pre class="w3-code">' + attr[1].string_data + '</pre>';
                else
                    html += attr[1] + "</p>";
            }
            contents.innerHTML = html;
            document.getElementById("sidebar").style.display = "block";
        } else {
            document.getElementById("sidebar-contents").innerHTML = "";
            document.getElementById("sidebar-header").innerText = "Nothing selected";
        }
    }
}

function close_menu() {
  document.getElementById("sidebar").style.display = "none";
}
</script>
</body>
</html>